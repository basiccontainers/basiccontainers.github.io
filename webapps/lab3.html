<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deployment slots | Basic Containers </title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Collection of resources for developers to get started on Azure">
    
    <link rel="preload" href="/assets/css/0.styles.6514b516.css" as="style"><link rel="preload" href="/assets/js/app.118d21cd.js" as="script"><link rel="preload" href="/assets/js/2.33b91e66.js" as="script"><link rel="preload" href="/assets/js/4.15d706e6.js" as="script"><link rel="prefetch" href="/assets/js/10.05c7de4b.js"><link rel="prefetch" href="/assets/js/11.8c5be6a9.js"><link rel="prefetch" href="/assets/js/12.87630292.js"><link rel="prefetch" href="/assets/js/13.88fe2e1e.js"><link rel="prefetch" href="/assets/js/14.17bd1cef.js"><link rel="prefetch" href="/assets/js/15.a78fd5a8.js"><link rel="prefetch" href="/assets/js/16.42e82f68.js"><link rel="prefetch" href="/assets/js/17.59bb41fd.js"><link rel="prefetch" href="/assets/js/3.040216d4.js"><link rel="prefetch" href="/assets/js/5.f337493f.js"><link rel="prefetch" href="/assets/js/6.4eddf5af.js"><link rel="prefetch" href="/assets/js/7.5494837b.js"><link rel="prefetch" href="/assets/js/8.45c9161c.js"><link rel="prefetch" href="/assets/js/9.e59b2424.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6514b516.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Basic Containers </span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="deployment-slots"><a href="#deployment-slots" class="header-anchor">#</a> Deployment slots</h2> <p>Deployment slots are live apps with their own hostnames. App content and configurations elements can be swapped between two deployment slots, including the production slot.
Using separate staging and production slots has several advantages.</p> <ul><li>You can validate app changes in a staging deployment slot before swapping it with the production slot.</li> <li>Deploying an app to a slot first and swapping it into production ensures that all instances of the slot are warmed up before being swapped into production. This eliminates downtime when you deploy your app. The traffic redirection is seamless, and no requests are dropped because of swap operations. This entire workflow can be automated by configuring Auto Swap when pre-swap validation is not needed.</li> <li>After a swap, the slot with previously staged app now has the previous production app. If the changes swapped into the production slot are not as you expected, you can perform the same swap immediately to get your “last known good site” back.-</li></ul> <p>For the new web app, you created only one slot: the production slot. You deployed source code to this slot.</p> <p>Next, you'll create a deployment slot where you can stage new versions of the web app. Whenever possible, use deployment slots when deploying a new production build. When using a Standard App Service Plan tier or better, you can deploy your app to a staging environment, validate your changes, and do smoke tests. When you are ready, you can swap your staging and production slots. The swap operation warms up the necessary worker instances to match your production scale, thus eliminating downtime.
<img src="/assets/img/lab3overview.886ff3bd.png" alt="lab1"></p> <h2 id="_1-modify-and-rebuild-application-for-deployment-slot"><a href="#_1-modify-and-rebuild-application-for-deployment-slot" class="header-anchor">#</a> 1 Modify and rebuild application  for Deployment slot</h2> <p>Before we configure any slots we create the application for the slot. For this we will simply modify the landing page. For this we will rebuilt our docker image under a new tag</p> <h3 id="modify-application-and-push-to-acr"><a href="#modify-application-and-push-to-acr" class="header-anchor">#</a> Modify application and push to ACR</h3> <ul><li>Navigate to the project from the <a href="/webapps/webappdeploy.html">Lab 2 - Deploy and run containers in Azure Webapps </a></li> <li>Set variables</li></ul> <div class="language- extra-class"><pre class="language-text"><code>resourceGroup=&quot;ivanresourcegroup&quot;
## This should be unique
appname=&quot;myapplicationivans&quot; 
## This should be unique
acr=&quot;ivanacrdemo&quot;
</code></pre></div><ul><li>Chnage directory to application project</li></ul> <div class="language- extra-class"><pre class="language-text"><code>cd mslearn-deploy-run-container-app-service/dotnet/SampleWeb/Pages
</code></pre></div><ul><li>Create the modified index pages by overwriting the previous one</li></ul> <div class="language- extra-class"><pre class="language-text"><code>cp Index.cshtml.new  Index.cshtml
</code></pre></div><ul><li>Navigate back to the Application root folder. this is the folder where the Dockerfile can be found(mslearn-deploy-run-container-app-service/dotnet/)</li></ul> <div class="language- extra-class"><pre class="language-text"><code>cd ../../
</code></pre></div><ul><li>Execute the following command. This command sends the folder's contents to Container Registry, which uses the instructions in the Docker file to build the image and store it. Take care not to leave out the . character at the end of the command.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>az acr build --registry $acr --image webimage:v2 .
</code></pre></div><h2 id="_2-create-a-preprod-slot"><a href="#_2-create-a-preprod-slot" class="header-anchor">#</a> 2 Create a Preprod Slot</h2> <h3 id="option-a-create-a-new-preproduction-slot-with-cli"><a href="#option-a-create-a-new-preproduction-slot-with-cli" class="header-anchor">#</a> (option a) Create a new Preproduction Slot with CLI</h3> <div class="language- extra-class"><pre class="language-text"><code>## Set variables 
resourceGroup=&quot;ivanresourcegroup&quot;
appname=&quot;myapplicationivans&quot; ## This should be unique
az webapp deployment slot  create  -s preprod --name $appname -g $resourceGroup
</code></pre></div><h3 id="option-b-create-a-new-preproduction-slot-in-the-portal"><a href="#option-b-create-a-new-preproduction-slot-in-the-portal" class="header-anchor">#</a> (option b)Create a new Preproduction Slot in the Portal</h3> <p>Create a new staging slot</p> <ul><li>On the Azure portal menu, or from the Home page, select All resources, filter by Type == App Service, and then select Apply.</li> <li>Select your web app. The App Service pane appears for your web app.</li> <li>In the left menu pane, under Deployment, select Deployment slots. The Deployment slots pane appears for your App Service</li> <li><img src="/assets/img/1slots.7585ae32.png" alt="registry"></li> <li>From the top menu bar, select Add Slot. The Add a slot pane appears.</li> <li>In the Name field, enter Staging, accept the default for Clone settings from, and then select Add.</li> <li>After the deployment slot is successfully created, select Close.</li></ul> <h3 id="view-slot"><a href="#view-slot" class="header-anchor">#</a> View Slot</h3> <h2 id="_3-configure-the-container-to-use-the-new-image"><a href="#_3-configure-the-container-to-use-the-new-image" class="header-anchor">#</a> 3 Configure the container to use the new image</h2> <h3 id="option-1-configure-new-image-in-the-portal-cli"><a href="#option-1-configure-new-image-in-the-portal-cli" class="header-anchor">#</a> option 1: Configure new image in the portal CLI</h3> <p>The following commans sets the Docker container for the App Service app.</p> <div class="language- extra-class"><pre class="language-text"><code>az webapp config container set -s preprod --docker-custom-image-name $acr.azurecr.io/webimage:v2 -g $resourceGroup --name $appname  --docker-registry-server-url  https://$acr.azurecr.io
</code></pre></div><h3 id="option-2-configure-the-container-in-portal"><a href="#option-2-configure-the-container-in-portal" class="header-anchor">#</a> option 2: Configure the Container in Portal</h3> <p>You can also configure the new slot to use the new image by</p> <ul><li>Go to Deployments slots and select click into the new slot</li> <li>This essentially navigates into a copy of your webapp. here you can configure the &quot;preprod&quot; slot with different configurations.</li> <li>To configure a different image. inside the slot select &quot;Configuration&quot;-&gt;Application Settings</li> <li>Modify the following configuration</li> <li>DOCKER_REGISTRY_SERVER_PASSWORD</li> <li>DOCKER_REGISTRY_SERVER_URL</li> <li>DOCKER_REGISTRY_SERVER_USERNAME
<img src="/assets/img/dockerimageslots.342a6b39.png" alt="registry"></li> <li></li></ul> <h3 id="view-new-deployment"><a href="#view-new-deployment" class="header-anchor">#</a> View new deployment</h3> <p>As an extra task. Navigate to the new deploy slot to test if the application deployment has taken place. Find the url of the application</p> <h2 id="_4-switch-slots-promoting-staging-to-production"><a href="#_4-switch-slots-promoting-staging-to-production" class="header-anchor">#</a> 4 Switch slots. Promoting staging to Production</h2> <p>You can swap deployment slots on your app's Deployment slots page and the Overview page. For technical details on the slot swap, see What happens during swap.</p> <ul><li>Go to your app's Deployment slots page and select Swap.</li> <li>The Swap dialog box shows settings in the selected source and target slots that will be changed.</li> <li><img src="/assets/img/swapbuttonbar.6d275942.png" alt="registry"></li> <li>Select the desired Source and Target slots. Usually, the target is the production slot. Also, select the Source Changes and Target Changes tabs and verify that the configuration changes are expected. When you're finished, you can swap the slots immediately by selecting Swap.
swapbuttonbar</li> <li><ul><li><img src="/assets/img/swapimmediately.80f83f7f.png" alt="registry"></li></ul></li></ul> <h2 id="_5-canary-routing"><a href="#_5-canary-routing" class="header-anchor">#</a> 5 Canary routing</h2> <p>By default, all client requests to the app's production URL (http://&lt;app_name&gt;.azurewebsites.net) are routed to the production slot. You can route a portion of the traffic to another slot.  This feature is often know as canary deployment is useful if you need user feedback for a new update, but you're not ready to release it to production.</p> <p>To route production traffic automatically:</p> <ul><li>Go to your app's resource page and select Deployment slots.</li> <li>In the Traffic % column of the slot you want to route to, specify a percentage (between 0 and 100) to represent the amount of total traffic you want to route. Select Save.</li> <li>In a new browser widow (icognito) browse to the application URL</li></ul> <p><img src="/assets/img/routetrafficslot.7e47fda1.png" alt="registry"></p> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ul><li>Staging : https://docs.microsoft.com/en-us/azure/app-service/scripts/cli-deploy-staging-environment?toc=/cli/azure/toc.json</li> <li>Setting image_: https://docs.microsoft.com/en-us/azure/app-service/scripts/cli-linux-docker-aspnetcore?toc=/cli/azure/toc.json</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.118d21cd.js" defer></script><script src="/assets/js/2.33b91e66.js" defer></script><script src="/assets/js/4.15d706e6.js" defer></script>
  </body>
</html>
